#!/usr/bin/bash
set -e
shopt -s nullglob

RED='\033[0;31m'
GREEN='\033[0;32m'
CYAN='\033[0;36m'
NC='\033[0m'
BOLD='\033[1m'

hint()
{
    echo -e "${CYAN}${BOLD}Hint: ${NC}$1"
}

warn()
{
    echo -e "${GREEN}${BOLD}Warning: ${NC}$1"
}

die()
{
    echo -e "${RED}${BOLD}Error: ${NC}$1"
    exit 1
}

usage()
{
    echo -e "\
Build system for meowOS packages

${GREEN}${BOLD}Usage: ${CYAN}${BOLD}$0 <COMMAND>

${GREEN}${BOLD}Commands:
${CYAN}${BOLD}  build    ${NC}Build a package"
}

usage_build()
{
    echo -e "\
${GREEN}${BOLD}Usage: ${CYAN}${BOLD}$0 build <PACKAGE>

${GREEN}${BOLD}Arguments:
${CYAN}${BOLD}  PACKAGE    ${NC}The name of the package to build

${GREEN}${BOLD}Options:
${CYAN}${BOLD}  -i         ${NC}Drop into an interactive shell"
}

stripall() {
    for dir in ./usr/lib ./usr/bin ./usr/sbin ./usr/libexec; do
        [[ -d "$dir" ]] || continue
        find "$dir" -type f \( -name '*.so*' ! -name '*dbg' -o -name '*.a' \) -exec strip --strip-debug {} +
    done
}

build()
{
    INTERACTIVE=0
    if [[ "$2" == "-i" ]]; then
        INTERACTIVE=1
        RECIPE="$3"
    elif [[ "$3" == "-i" ]]; then
        INTERACTIVE=1
        RECIPE="$2"
    else
        RECIPE="$2"
    fi
    if [[ -z "$RECIPE" ]]; then
        usage_build
        exit 2
    fi
    
    if [[ ! -d "$RECIPE" ]]; then
        die "Recipe directory \`$RECIPE\` does not exist"
    fi

    if [[ ! -f "$RECIPE/recipe" ]]; then
        if [[ -f "$RECIPE/recipy" ]]; then
            hint "\`$RECIPE/recipy\` exists, but it should be named \`$RECIPE/recipe\`"
        fi
        die "Recipe script \`$RECIPE/recipe\` does not exist"
    fi

    source "$RECIPE/recipe"

    mkdir -p /tmp/meow-craft/sources
    
    if [[ -z $SOURCE ]]; then
        SOURCE_PATH=/tmp/meow-craft/sources/null.tar.gz
        SOURCE_DIR=/tmp/meow-craft/sources/null
        mkdir -p "$SOURCE_DIR"
    else
        wget -nc -q --show-progress -P /tmp/meow-craft/sources "$SOURCE" || die "Failed to download source from \`$SOURCE\`"
        SOURCE_PATH="/tmp/meow-craft/sources/$(basename "$SOURCE")"
        SOURCE_DIR="/tmp/meow-craft/sources/$(tar -tf "$SOURCE_PATH" | head -n 1)"
        rm -rf "$SOURCE_DIR"
        tar -C /tmp/meow-craft/sources -xf "$SOURCE_PATH" || die "Failed to extract source archive"

        for fPatch in $RECIPE/*.patch; do
            patch -Np1 -i $fPatch -d $SOURCE_DIR
        done
    fi

    export RECIPE
    export DESTDIR="/tmp/meow-craft/builds/$NAME-$VERSION-$RELEASE"
    rm -rf $DESTDIR
    mkdir -p $DESTDIR
    if [[ $INTERACTIVE -eq 1 ]]; then
        echo -e "${GREEN}${BOLD}Info: ${NC}Dropping into interactive shell. Exit to continue the build. (exit 1 to abort)"
        bash -i
    else
        bash -c "set -e; source \"$RECIPE/recipe\"; cd \"$SOURCE_DIR\"; build" || die "Build failed"
    fi
    for i in COPYING{,.txt,.md} LICENSE{,.txt,.md} copying{,.txt,.md} license{,.txt,.md} UNLICENSE; do
        if [[ -f "$SOURCE_DIR/$i" ]]; then
            install -Dm644 "$SOURCE_DIR/$i" "$DESTDIR/usr/share/licenses/$NAME/$i"
        fi
    done
    for i in {pre,post}-{install,remove}; do
        cp $RECIPE/$i $DESTDIR 2>/dev/null || true
    done
    rm -rf $DESTDIR/usr/share/{info,doc}
    rmdir -p --ignore-fail-on-non-empty $DESTDIR/usr/share
    cd $DESTDIR
    stripall
    rm -f $DESTDIR.mz
    meow-zip create $DESTDIR.mz \
        --name $NAME \
        --version $VERSION \
        --release $RELEASE \
        --license "$LICENSE" \
        --depends "$DEPENDS" \
        --packager "$PACKAGER"
    meow-zip list $DESTDIR.mz
    echo -e "${GREEN}${BOLD}Success: ${NC}Package built at \`$DESTDIR.mz\`"
}

[[ -f /etc/meow-craft ]] && source /etc/meow-craft

[[ -z $PACKAGER ]] && die "PACKAGER is not set. Please set it in /etc/meow-craft"

case "$1" in
    build)
        build "$@"
        ;;
    *)
        usage
        exit 2
        ;;
esac
